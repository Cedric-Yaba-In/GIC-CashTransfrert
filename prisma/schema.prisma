generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
  relationMode = "prisma"
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique @db.VarChar(191)
  password  String   @db.VarChar(191)
  role      UserRole @default(ADMIN)
  name      String   @db.VarChar(191)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ticketMessages TicketMessage[]

  @@map("users")
}

model Region {
  id        Int      @id @default(autoincrement())
  name      String   @unique @db.VarChar(100)
  code      String   @unique @db.VarChar(50)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  countries Country[]

  @@map("regions")
}

model Country {
  id           Int     @id @default(autoincrement())
  name         String  @db.VarChar(191)
  code         String  @unique @db.VarChar(10)
  currency     String  @db.VarChar(100)
  currencyCode String  @db.VarChar(10)
  flag         String  @db.VarChar(191)
  callingCode  String? @db.VarChar(10)
  regionId     Int?
  active       Boolean @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  region Region? @relation(fields: [regionId], references: [id])
  paymentMethods CountryPaymentMethod[]
  wallet Wallet?
  banks Bank[]
  bankAccounts BankAccount[]
  senderTransactions Transaction[] @relation("SenderTransactions")
  receiverTransactions Transaction[] @relation("ReceiverTransactions")
  senderCorridors   TransferCorridor[] @relation("SenderCorridors")
  receiverCorridors TransferCorridor[] @relation("ReceiverCorridors")
  countryRates      CountryTransferRate[]

  @@map("countries")
}

model PaymentMethod {
  id          Int               @id @default(autoincrement())
  name        String            @db.VarChar(191)
  type        PaymentMethodType
  category    PaymentCategory   @default(HYBRID)
  subType     String?           @db.VarChar(50)
  bankId      Int?
  minAmount   Decimal           @default(0)
  maxAmount   Decimal?
  active      Boolean           @default(true)
  isGlobal    Boolean           @default(false)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  countries CountryPaymentMethod[]
  senderTransactions Transaction[] @relation("SenderPaymentTransactions")
  receiverTransactions Transaction[] @relation("ReceiverPaymentTransactions")
  bank        Bank?             @relation(fields: [bankId], references: [id])

  @@map("payment_methods")
}

model Transaction {
  id                    Int               @id @default(autoincrement())
  reference             String            @unique @db.VarChar(100)
  senderName            String            @db.VarChar(191)
  senderEmail           String            @db.VarChar(191)
  senderPhone           String            @db.VarChar(50)
  senderCountryId       Int
  receiverName          String            @db.VarChar(191)
  receiverEmail         String?           @db.VarChar(191)
  receiverPhone         String            @db.VarChar(50)
  receiverCountryId     Int
  amount                Decimal
  fees                  Decimal           @default(0)
  totalAmount           Decimal
  senderPaymentMethodId Int
  receiverPaymentMethodId Int?
  status                TransactionStatus @default(PENDING)
  paymentProof          String?           @db.VarChar(191)
  flutterwaveRef        String?           @db.VarChar(191)
  paidAt                DateTime?
  receiverSubMethod     String?           @db.VarChar(50)
  adminNotes            String?           @db.Text
  sentAt                DateTime?
  receivedAt            DateTime?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  senderCountry         Country           @relation("SenderTransactions", fields: [senderCountryId], references: [id])
  receiverCountry       Country           @relation("ReceiverTransactions", fields: [receiverCountryId], references: [id])
  senderPaymentMethod   PaymentMethod     @relation("SenderPaymentTransactions", fields: [senderPaymentMethodId], references: [id])
  receiverPaymentMethod PaymentMethod?    @relation("ReceiverPaymentTransactions", fields: [receiverPaymentMethodId], references: [id])
  tickets               Ticket[]

  @@map("transactions")
}

model CountryPaymentMethod {
  id              Int     @id @default(autoincrement())
  countryId       Int
  paymentMethodId Int
  active          Boolean @default(true)
  minAmount       Decimal?
  maxAmount       Decimal?
  fees            Decimal @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  country       Country       @relation(fields: [countryId], references: [id], onDelete: Cascade)
  paymentMethod PaymentMethod @relation(fields: [paymentMethodId], references: [id], onDelete: Cascade)
  subWallet     SubWallet?

  @@unique([countryId, paymentMethodId])
  @@map("country_payment_methods")
}

model Wallet {
  id        Int      @id @default(autoincrement())
  countryId Int      @unique
  balance   Decimal  @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  country    Country     @relation(fields: [countryId], references: [id], onDelete: Cascade)
  subWallets SubWallet[]

  @@map("wallets")
}

model Bank {
  id            Int      @id @default(autoincrement())
  name          String   @db.VarChar(191)
  code          String   @db.VarChar(20)
  countryCode   String   @db.VarChar(10)
  logo          String?  @db.VarChar(500)
  website       String?  @db.VarChar(191)
  swiftCode     String?  @db.VarChar(20)
  routingNumber String?  @db.VarChar(50)
  source        String   @default("MANUAL") @db.VarChar(20) // FLUTTERWAVE, MANUAL, API
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  country       Country  @relation(fields: [countryCode], references: [code])
  subWallets    SubWallet[]
  configuration BankConfiguration?
  paymentMethods PaymentMethod[]
  bankAccounts  BankAccount[]

  @@unique([code, countryCode])
  @@map("banks")
}

model BankConfiguration {
  id                 Int      @id @default(autoincrement())
  bankId             Int      @unique
  accountNumber      String   @db.VarChar(50)
  accountName        String   @db.VarChar(191)
  iban               String?  @db.VarChar(50)
  beneficiaryAddress String?  @db.Text
  active             Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  bank Bank @relation(fields: [bankId], references: [id], onDelete: Cascade)

  @@map("bank_configurations")
}

model BankAccount {
  id            Int      @id @default(autoincrement())
  bankId        Int
  countryId     Int
  accountName   String   @db.VarChar(191)
  accountNumber String   @db.VarChar(191)
  iban          String?  @db.VarChar(50)
  swiftCode     String?  @db.VarChar(20)
  routingNumber String?  @db.VarChar(50)
  branchCode    String?  @db.VarChar(20)
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  bank    Bank    @relation(fields: [bankId], references: [id], onDelete: Cascade)
  country Country @relation(fields: [countryId], references: [id], onDelete: Cascade)

  @@unique([bankId, countryId])
  @@map("bank_accounts")
}

model SubWallet {
  id                      Int     @id @default(autoincrement())
  walletId                Int
  countryPaymentMethodId  Int     @unique
  balance                 Decimal @default(0)
  active                  Boolean @default(true)
  readOnly                Boolean @default(false)
  bankId                  Int?
  accountNumber           String? @db.VarChar(50)
  accountName             String? @db.VarChar(191)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  wallet                Wallet                @relation(fields: [walletId], references: [id], onDelete: Cascade)
  countryPaymentMethod  CountryPaymentMethod  @relation(fields: [countryPaymentMethodId], references: [id], onDelete: Cascade)
  bank                  Bank?                 @relation(fields: [bankId], references: [id])

  @@map("sub_wallets")
}

model Configuration {
  id        Int      @id @default(autoincrement())
  key       String   @unique @db.VarChar(100)
  value     String?  @db.Text
  category  String   @db.VarChar(50)
  type      String   @db.VarChar(20)
  label     String   @db.VarChar(191)
  required  Boolean  @default(false)
  encrypted Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("configurations")
}

enum UserRole {
  ADMIN
  VIEWER
}

enum PaymentMethodType {
  API
  MANUAL
  FLUTTERWAVE
  BANK_TRANSFER
  MOBILE_MONEY
}

enum PaymentCategory {
  HYBRID
  BANK_TRANSFER
  MOBILE_MONEY
}

enum TransactionStatus {
  PENDING
  PAID
  APPROVED
  REJECTED
  COMPLETED
  FAILED
  CANCELLED
}

model Ticket {
  id            Int         @id @default(autoincrement())
  transactionId Int?
  subject       String      @db.VarChar(191)
  status        TicketStatus @default(OPEN)
  priority      TicketPriority @default(NORMAL)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  transaction   Transaction? @relation(fields: [transactionId], references: [id])
  messages      TicketMessage[]

  @@map("tickets")
}

model TicketMessage {
  id        Int      @id @default(autoincrement())
  ticketId  Int
  message   String   @db.Text
  isAdmin   Boolean  @default(false)
  adminId   Int?
  createdAt DateTime @default(now())

  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  admin     User?    @relation(fields: [adminId], references: [id])

  @@map("ticket_messages")
}

enum ConfigType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  PASSWORD
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model TransferRate {
  id                Int      @id @default(autoincrement())
  name              String   @db.VarChar(191)
  description       String?  @db.Text
  baseFee           Decimal  @default(0)
  percentageFee     Decimal  @default(0)
  minAmount         Decimal  @default(0)
  maxAmount         Decimal?
  exchangeRateMargin Decimal @default(0)
  active            Boolean  @default(true)
  isDefault         Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  countryRates      CountryTransferRate[]
  corridorRates     TransferCorridor[]

  @@map("transfer_rates")
}

model CountryTransferRate {
  id              Int      @id @default(autoincrement())
  countryId       Int
  transferRateId  Int
  baseFee         Decimal?
  percentageFee   Decimal?
  minAmount       Decimal?
  maxAmount       Decimal?
  exchangeRateMargin Decimal?
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  country         Country      @relation(fields: [countryId], references: [id], onDelete: Cascade)
  transferRate    TransferRate @relation(fields: [transferRateId], references: [id], onDelete: Cascade)

  @@unique([countryId, transferRateId])
  @@map("country_transfer_rates")
}

model TransferCorridor {
  id                Int      @id @default(autoincrement())
  senderCountryId   Int
  receiverCountryId Int
  transferRateId    Int?
  baseFee           Decimal?
  percentageFee     Decimal?
  minAmount         Decimal?
  maxAmount         Decimal?
  exchangeRateMargin Decimal?
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  senderCountry     Country       @relation("SenderCorridors", fields: [senderCountryId], references: [id], onDelete: Cascade)
  receiverCountry   Country       @relation("ReceiverCorridors", fields: [receiverCountryId], references: [id], onDelete: Cascade)
  transferRate      TransferRate? @relation(fields: [transferRateId], references: [id])

  @@unique([senderCountryId, receiverCountryId])
  @@map("transfer_corridors")
}

model ExchangeRate {
  id              Int      @id @default(autoincrement())
  fromCurrency    String   @db.VarChar(10)
  toCurrency      String   @db.VarChar(10)
  rate            Decimal  @db.Decimal(18, 8)
  source          String   @db.VarChar(50)
  lastUpdated     DateTime @default(now())
  createdAt       DateTime @default(now())

  @@unique([fromCurrency, toCurrency])
  @@map("exchange_rates")
}